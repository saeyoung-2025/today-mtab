<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ë¶€ - Today App</title>
    <link rel="icon" type="image/png" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           Today App - Money/Budget Page
           Unified Minimal Design System
        ============================================ */
        
        :root {
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border-color: #E5E7EB;
            --accent: #3B82F6;
            --accent-light: #EFF6FF;
            --success: #10B981;
            --success-light: #D1FAE5;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.2s ease;
        }

        body.theme-gray {
            --bg-primary: #F3F4F6;
            --bg-secondary: #E5E7EB;
            --bg-card: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --text-muted: #9CA3AF;
            --border-color: #D1D5DB;
            --accent: #6366F1;
            --accent-light: #EEF2FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            transition: var(--transition);
        }

        .container {
            max-width: 100%;
        }

        /* Header */
        .page-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .page-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-header h1 i {
            color: var(--accent);
            margin-right: 8px;
        }

        /* Balance Display */
        .balance-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .balance-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .balance-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .nav-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn:hover:not(:disabled) {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-indicator {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--accent);
        }

        /* Page Content */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.75rem;
        }

        /* Action Buttons Group */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .action-buttons .btn {
            flex: 1;
        }

        /* Monthly Stats Summary */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
        }

        .stat-item .label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .stat-item .value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stat-item .value.income {
            color: var(--success);
        }

        .stat-item .value.expense {
            color: var(--danger);
        }

        .stat-item .value.balance {
            color: var(--accent);
        }

        /* Chart Container */
        .chart-container {
            margin-top: 16px;
        }

        /* Ledger Table */
        .ledger-month {
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .ledger-month-header {
            background: var(--accent);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            text-align: center;
        }

        .ledger-month-stats {
            display: flex;
            justify-content: space-around;
            padding: 12px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ledger-table th,
        .ledger-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .ledger-table th {
            background: var(--bg-primary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .ledger-table tbody tr:hover {
            background: var(--bg-primary);
        }

        .ledger-table .income-text {
            color: var(--success);
        }

        .ledger-table .expense-text {
            color: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .year-stat-box {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .year-stat-box .year {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .year-stat-box .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-right: 30px;
        }

        /* Danger Card */
        .danger-card {
            border-color: var(--danger);
            background: var(--danger-light);
        }

        .danger-card .card-title {
            color: var(--danger);
        }

        .danger-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        /* Backup Card */
        .backup-card {
            border-color: var(--accent);
        }

        .backup-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .backup-btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .backup-btn-group .btn {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-wallet"></i>ê°€ê³„ë¶€</h1>
        </div>

        <div class="balance-card">
            <div class="balance-label" id="balanceLabel">ì˜¬í•´ ì´ ì”ì•¡</div>
            <div class="balance-value" id="currentBalance">0ì›</div>
        </div>

        <div class="nav-bar">
            <button id="prevPageBtn" class="nav-btn">
                <i class="fas fa-chevron-left"></i> ì´ì „
            </button>
            <span class="page-indicator" id="pageIndicator">1 / 3</span>
            <button id="nextPageBtn" class="nav-btn">
                ë‹¤ìŒ <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <!-- Page 1: Record -->
        <div id="page1" class="page-content active">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-plus-circle"></i>
                    ìƒˆ ê±°ë˜ ê¸°ë¡
                </div>
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="budgetDate" class="form-input">
                </div>
                <div class="form-group">
                    <label>ìœ í˜•</label>
                    <select id="budgetType" class="form-select">
                        <option value="expense">ì§€ì¶œ</option>
                        <option value="income">ìˆ˜ì…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="budgetAmount" class="form-input" placeholder="ê¸ˆì•¡ ì…ë ¥" min="1">
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <select id="budgetCategory" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label>ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="budgetMemo" class="form-textarea" placeholder="ê°„ë‹¨í•œ ë©”ëª¨"></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="clearInputBtn">
                        <i class="fas fa-eraser"></i> ë¹„ìš°ê¸°
                    </button>
                    <button class="btn btn-success" id="saveBudgetBtn">
                        <i class="fas fa-save"></i> ì €ì¥
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    ì´ë²ˆ ë‹¬ í˜„í™©
                </div>
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="label">ìˆ˜ì…</div>
                        <div class="value income" id="monthlyIncome">0ì›</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">ì§€ì¶œ</div>
                        <div class="value expense" id="monthlyExpense">0ì›</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">ì”ì•¡</div>
                        <div class="value balance" id="monthlyBalance">0ì›</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="dailyExpenseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Page 2: Ledger -->
        <div id="page2" class="page-content">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-book"></i>
                    ì›”ë³„ ì¥ë¶€
                </div>
                <div id="monthlyLedgersContent">
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>ê¸°ë¡ëœ ì¥ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Stats & Settings -->
        <div id="page3" class="page-content">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-bullseye"></i>
                    ë‚˜ì˜ ëª©í‘œ
                </div>
                <!-- ì €ì¥ëœ ëª©í‘œ í‘œì‹œ ì˜ì—­ -->
                <div id="goalDisplayArea" style="display: none;">
                    <div id="goalDisplayText" style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 16px; line-height: 1.6; white-space: pre-wrap;"></div>
                    <div class="action-buttons">
                        <button id="editGoalBtn" class="btn btn-primary">
                            <i class="fas fa-edit"></i> ìˆ˜ì •
                        </button>
                        <button id="deleteGoalBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> ì‚­ì œ
                        </button>
                    </div>
                </div>
                <!-- ì…ë ¥/ìˆ˜ì • ì˜ì—­ -->
                <div id="goalEditArea">
                    <div class="form-group">
                        <textarea id="goalMemoInput" class="form-textarea" placeholder="ì¥ê¸° ì¬ì • ëª©í‘œë¥¼ ì„¤ì •í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <div class="action-buttons">
                        <button id="saveGoalBtn" class="btn btn-primary">
                            <i class="fas fa-save"></i> ì €ì¥
                        </button>
                        <button id="cancelGoalBtn" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-times"></i> ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i>
                    5ê°œë…„ í†µê³„
                </div>
                <div class="stats-grid" id="fiveYearStatsContent">
                    <div class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <p>í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <div class="card backup-card">
                <div class="card-title">
                    <i class="fas fa-cloud"></i>
                    ë°ì´í„° ë°±ì—…/ë³µì›
                </div>
                <p>ë°±ì—… ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬í•œ í›„ ë©”ëª¨ì¥ì— ì €ì¥í•˜ì„¸ìš”.</p>
                <div class="backup-btn-group">
                    <button class="btn btn-primary" onclick="displayDataAsJson()">
                        <i class="fas fa-download"></i> ë°±ì—… ë°ì´í„° í‘œì‹œ
                    </button>
                    <input type="file" id="backupFileInput" accept=".json, .txt" style="display: none;" onchange="importDataFromJson(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('backupFileInput').click()">
                        <i class="fas fa-upload"></i> ë°±ì—… íŒŒì¼ ë³µì›
                    </button>
                </div>
            </div>

            <div class="card danger-card">
                <div class="card-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    ìœ„í—˜ êµ¬ì—­
                </div>
                <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª¨ë“  ê°€ê³„ë¶€ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
                <button id="globalResetBtn" class="btn btn-danger" style="width: 100%;">
                    <i class="fas fa-trash"></i> ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                </button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div class="modal-title">ê±°ë˜ ìˆ˜ì •</div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Theme handling
        window.addEventListener('message', (event) => {
            if (event.data.type === 'themeChange') {
                document.body.classList.remove('theme-gray');
                if (event.data.theme === 'gray') {
                    document.body.classList.add('theme-gray');
                }
            }
        });

        const savedTheme = localStorage.getItem('today_app_theme');
        if (savedTheme === 'gray') {
            document.body.classList.add('theme-gray');
        }

        // Database
        const db = new Dexie('BudgetAppDB');
        db.version(3).stores({
            budgets: '++id, date, type, amount, category',
            goals: 'id',
        });

        let dailyExpenseChartInstance = null;
        let currentPage = 1;
        const totalPages = 3;
        let currentEditingId = null;

        // Categories
        const categories = {
            expense: [
                { value: 'ì‹ë¹„', label: 'ğŸ” ì‹ë¹„' },
                { value: 'êµí†µ', label: 'ğŸšŒ êµí†µ' },
                { value: 'ì‡¼í•‘', label: 'ğŸ›ï¸ ì‡¼í•‘' },
                { value: 'ìƒí™œ', label: 'ğŸ  ìƒí™œ' },
                { value: 'ê²½ì¡°ì‚¬', label: 'ğŸ ê²½ì¡°ì‚¬' },
                { value: 'ê¸°íƒ€_ì§€ì¶œ', label: 'ğŸ“¦ ê¸°íƒ€' }
            ],
            income: [
                { value: 'ì›”ê¸‰', label: 'ğŸ’µ ì›”ê¸‰' },
                { value: 'ìš©ëˆ', label: 'ğŸ’° ìš©ëˆ' },
                { value: 'ë¶€ìˆ˜ì…', label: 'âœ¨ ë¶€ìˆ˜ì…' },
                { value: 'ê¸°íƒ€_ìˆ˜ì…', label: 'ğŸ“¦ ê¸°íƒ€' }
            ]
        };

        // Utility functions
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function formatAmount(amount) {
            return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
        }

        function updateCategoryOptions(type, targetSelect, selectedValue = null) {
            targetSelect.innerHTML = '';
            const categoryList = categories[type] || categories.expense;
            categoryList.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.value;
                option.textContent = cat.label;
                if (selectedValue === cat.value) option.selected = true;
                targetSelect.appendChild(option);
            });
        }

        function clearInputFields() {
            document.getElementById('budgetDate').value = getTodayDateString();
            document.getElementById('budgetType').value = 'expense';
            document.getElementById('budgetAmount').value = '';
            document.getElementById('budgetMemo').value = '';
            updateCategoryOptions('expense', document.getElementById('budgetCategory'));
        }

        // Page Navigation
        function showPage(pageNumber) {
            currentPage = Math.min(Math.max(pageNumber, 1), totalPages);

            document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`page${currentPage}`).classList.add('active');

            document.getElementById('pageIndicator').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = (currentPage === 1);
            document.getElementById('nextPageBtn').disabled = (currentPage === totalPages);

            if (currentPage === 1) refreshAllData();
            if (currentPage === 2) renderMonthlyLedgersView();
            if (currentPage === 3) {
                calculateFiveYearStats();
                loadGoal();
            }
        }

        // Save Budget
        async function saveBudget() {
            const date = document.getElementById('budgetDate').value;
            const type = document.getElementById('budgetType').value;
            const amount = parseInt(document.getElementById('budgetAmount').value, 10);
            const category = document.getElementById('budgetCategory').value;
            const memo = document.getElementById('budgetMemo').value.trim();

            if (!date || !type || !amount || !category || amount <= 0) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                await db.budgets.add({
                    timestamp: new Date().getTime(),
                    date: date,
                    type: type,
                    amount: amount,
                    category: category,
                    memo: memo
                });
                clearInputFields();
                refreshAllData();
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // Calculate Yearly Balance (ì˜¬í•´ ì´ ì”ì•¡)
        async function calculateTotalBalance() {
            const allBudgets = await db.budgets.toArray();
            const currentYear = new Date().getFullYear().toString();
            
            // Filter only current year data (date format: YYYY-MM-DD)
            const yearlyData = allBudgets.filter(entry => {
                if (entry.date && entry.date.length >= 4) {
                    return entry.date.substring(0, 4) === currentYear;
                }
                return false;
            });
            
            let income = 0, expense = 0;

            yearlyData.forEach(entry => {
                if (entry.type === 'income') income += entry.amount;
                else expense += entry.amount;
            });

            const balance = income - expense;
            document.getElementById('currentBalance').textContent = formatAmount(balance);
            
            // Save to localStorage for main page
            localStorage.setItem('moneyBalance', balance);
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'statsUpdate' }, '*');
            }
        }

        // Update Monthly Stats
        async function updateMonthlyStats() {
            const today = getTodayDateString();
            const currentMonth = today.substring(0, 7);
            const allBudgets = await db.budgets.toArray();
            const monthlyData = allBudgets.filter(entry => entry.date.startsWith(currentMonth));

            let income = 0, expense = 0;
            const dailyExpenses = {};

            monthlyData.forEach(entry => {
                if (entry.type === 'income') income += entry.amount;
                else {
                    expense += entry.amount;
                    dailyExpenses[entry.date] = (dailyExpenses[entry.date] || 0) + entry.amount;
                }
            });

            document.getElementById('monthlyIncome').textContent = formatAmount(income);
            document.getElementById('monthlyExpense').textContent = formatAmount(expense);
            document.getElementById('monthlyBalance').textContent = formatAmount(income - expense);

            // Save monthly balance to localStorage for main page
            localStorage.setItem('moneyMonthlyBalance', income - expense);
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'statsUpdate' }, '*');
            }

            renderDailyExpenseChart(dailyExpenses);
        }

        // Render Chart
        function renderDailyExpenseChart(dailyExpenses) {
            if (dailyExpenseChartInstance) dailyExpenseChartInstance.destroy();

            const dates = Object.keys(dailyExpenses).sort();
            const amounts = dates.map(date => dailyExpenses[date]);

            const ctx = document.getElementById('dailyExpenseChart').getContext('2d');
            dailyExpenseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates.map(d => d.substring(5)),
                    datasets: [{
                        label: 'ì¼ë³„ ì§€ì¶œ',
                        data: amounts,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Render Monthly Ledgers
        async function renderMonthlyLedgersView() {
            const allBudgets = await db.budgets.toArray();
            const monthlyLedgers = {};

            allBudgets.forEach(entry => {
                const month = entry.date.substring(0, 7);
                if (!monthlyLedgers[month]) monthlyLedgers[month] = [];
                monthlyLedgers[month].push(entry);
            });

            const sortedMonths = Object.keys(monthlyLedgers).sort().reverse();
            const container = document.getElementById('monthlyLedgersContent');

            if (sortedMonths.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>ê¸°ë¡ëœ ì¥ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            let html = '';
            sortedMonths.forEach(month => {
                const entries = monthlyLedgers[month].sort((a, b) => new Date(b.date) - new Date(a.date));
                let incomeTotal = 0, expenseTotal = 0;

                entries.forEach(entry => {
                    if (entry.type === 'income') incomeTotal += entry.amount;
                    else expenseTotal += entry.amount;
                });

                html += `
                    <div class="ledger-month">
                        <div class="ledger-month-header">${month}</div>
                        <div class="ledger-month-stats">
                            <span class="income-text">ìˆ˜ì…: ${formatAmount(incomeTotal)}</span>
                            <span class="expense-text">ì§€ì¶œ: ${formatAmount(expenseTotal)}</span>
                        </div>
                        <table class="ledger-table">
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ë¶„ë¥˜</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${entries.map(entry => {
                                    const categoryLabel = categories[entry.type].find(c => c.value === entry.category)?.label || entry.category;
                                    return `
                                        <tr>
                                            <td>${entry.date.substring(5)}</td>
                                            <td class="${entry.type === 'income' ? 'income-text' : 'expense-text'}">${categoryLabel}</td>
                                            <td class="${entry.type === 'income' ? 'income-text' : 'expense-text'}">${formatAmount(entry.amount)}</td>
                                            <td><button class="btn btn-sm btn-secondary" onclick="openBudgetModal(${entry.id})"><i class="fas fa-edit"></i></button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Modal Functions
        async function openBudgetModal(id) {
            currentEditingId = id;
            const entry = await db.budgets.get(id);
            if (!entry) {
                alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="modalDate" class="form-input" value="${entry.date}">
                </div>
                <div class="form-group">
                    <label>ìœ í˜•</label>
                    <select id="modalType" class="form-select">
                        <option value="expense" ${entry.type === 'expense' ? 'selected' : ''}>ì§€ì¶œ</option>
                        <option value="income" ${entry.type === 'income' ? 'selected' : ''}>ìˆ˜ì…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ê¸ˆì•¡</label>
                    <input type="number" id="modalAmount" class="form-input" value="${entry.amount}">
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <select id="modalCategory" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label>ë©”ëª¨</label>
                    <textarea id="modalMemo" class="form-textarea">${entry.memo || ''}</textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveModalBudget()">
                        <i class="fas fa-save"></i> ìˆ˜ì •
                    </button>
                    <button class="btn btn-danger" onclick="deleteBudgetEntry(${id})">
                        <i class="fas fa-trash"></i> ì‚­ì œ
                    </button>
                </div>
            `;

            updateCategoryOptions(entry.type, document.getElementById('modalCategory'), entry.category);
            document.getElementById('modalType').onchange = (e) => {
                updateCategoryOptions(e.target.value, document.getElementById('modalCategory'));
            };

            document.getElementById('budgetModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('budgetModal').classList.remove('active');
        }

        async function saveModalBudget() {
            if (!currentEditingId) return;

            const date = document.getElementById('modalDate').value;
            const type = document.getElementById('modalType').value;
            const amount = parseInt(document.getElementById('modalAmount').value, 10);
            const category = document.getElementById('modalCategory').value;
            const memo = document.getElementById('modalMemo').value.trim();

            if (!date || !amount || amount <= 0) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const existing = await db.budgets.get(currentEditingId);
                await db.budgets.put({
                    id: currentEditingId,
                    timestamp: existing.timestamp,
                    date, type, amount, category, memo
                });
                closeModal();
                refreshAllData();
                renderMonthlyLedgersView();
            } catch (error) {
                alert('ìˆ˜ì • ì˜¤ë¥˜: ' + error.message);
            }
        }

        async function deleteBudgetEntry(id) {
            if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await db.budgets.delete(id);
                closeModal();
                refreshAllData();
                renderMonthlyLedgersView();
            }
        }

        // Goal Management
        async function loadGoal() {
            try {
                const goal = await db.goals.get(1);
                const displayArea = document.getElementById('goalDisplayArea');
                const editArea = document.getElementById('goalEditArea');
                const displayText = document.getElementById('goalDisplayText');
                const cancelBtn = document.getElementById('cancelGoalBtn');
                
                if (goal && goal.memo && goal.memo.trim() !== '') {
                    // ì €ì¥ëœ ëª©í‘œê°€ ìˆìœ¼ë©´ í‘œì‹œ ëª¨ë“œ
                    displayText.textContent = goal.memo;
                    displayArea.style.display = 'block';
                    editArea.style.display = 'none';
                } else {
                    // ì €ì¥ëœ ëª©í‘œê°€ ì—†ìœ¼ë©´ ì…ë ¥ ëª¨ë“œ
                    displayArea.style.display = 'none';
                    editArea.style.display = 'block';
                    cancelBtn.style.display = 'none';
                    document.getElementById('goalMemoInput').value = '';
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function saveGoal() {
            const memo = document.getElementById('goalMemoInput').value.trim();
            if (!memo) {
                alert('ëª©í‘œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            try {
                await db.goals.put({ id: 1, memo: memo });
                alert('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¯');
                loadGoal(); // í™”ë©´ ê°±ì‹ 
            } catch (error) {
                alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message);
            }
        }

        function editGoal() {
            const displayArea = document.getElementById('goalDisplayArea');
            const editArea = document.getElementById('goalEditArea');
            const displayText = document.getElementById('goalDisplayText');
            const cancelBtn = document.getElementById('cancelGoalBtn');
            
            // í˜„ì¬ ë‚´ìš©ì„ ì…ë ¥ì°½ì— ë„£ê¸°
            document.getElementById('goalMemoInput').value = displayText.textContent;
            displayArea.style.display = 'none';
            editArea.style.display = 'block';
            cancelBtn.style.display = 'inline-flex';
        }

        function cancelEditGoal() {
            loadGoal(); // ì›ë˜ ìƒíƒœë¡œ ë³µì›
        }

        async function deleteGoal() {
            if (confirm('ëª©í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await db.goals.delete(1);
                    alert('ëª©í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadGoal(); // í™”ë©´ ê°±ì‹ 
                } catch (error) {
                    alert('ì‚­ì œ ì˜¤ë¥˜: ' + error.message);
                }
            }
        }

        // Five Year Stats
        async function calculateFiveYearStats() {
            const allBudgets = await db.budgets.toArray();
            const annualStats = {};

            allBudgets.forEach(entry => {
                const year = entry.date.substring(0, 4);
                if (!annualStats[year]) annualStats[year] = { income: 0, expense: 0 };
                if (entry.type === 'income') annualStats[year].income += entry.amount;
                else annualStats[year].expense += entry.amount;
            });

            const currentYear = new Date().getFullYear();
            const yearsToShow = [];
            for (let i = 0; i < 5; i++) {
                const year = (currentYear - i).toString();
                yearsToShow.push(year);
            }

            const container = document.getElementById('fiveYearStatsContent');
            
            if (Object.keys(annualStats).length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-chart-bar"></i>
                        <p>í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            let html = '';
            yearsToShow.forEach(year => {
                const stats = annualStats[year] || { income: 0, expense: 0 };
                const balance = stats.income - stats.expense;

                html += `
                    <div class="year-stat-box">
                        <div class="year">${year}ë…„</div>
                        <div class="stat-row">
                            <span>ìˆ˜ì…</span>
                            <span class="income-text">${formatAmount(stats.income)}</span>
                        </div>
                        <div class="stat-row">
                            <span>ì§€ì¶œ</span>
                            <span class="expense-text">${formatAmount(stats.expense)}</span>
                        </div>
                        <div class="stat-row">
                            <span>ìˆœìì‚°</span>
                            <span class="balance-text">${formatAmount(balance)}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Global Reset
        async function globalReset() {
            const confirmation = prompt('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ë ¤ë©´ "ì´ˆê¸°í™”"ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            if (confirmation === 'ì´ˆê¸°í™”') {
                await db.budgets.clear();
                await db.goals.clear();
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                clearInputFields();
                refreshAllData();
            }
        }

        // Backup/Restore
        async function displayDataAsJson() {
            const budgets = await db.budgets.toArray();
            const goals = await db.goals.toArray();
            
            if (budgets.length === 0 && goals.length === 0) {
                alert('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const data = JSON.stringify({ budgets, goals }, null, 2);
            const win = window.open("", "_blank", "width=600,height=600");
            win.document.write('<h2>ë°±ì—… ë°ì´í„°</h2>');
            win.document.write('<p style="color: #666;">ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ ë©”ëª¨ì¥ì— ì €ì¥í•˜ì„¸ìš”.</p>');
            win.document.write('<textarea style="width: 100%; height: 80%; font-size: 12px;">' + data + '</textarea>');
            win.document.close();
        }

        async function importDataFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('ë³µì› ì‹œ ê¸°ì¡´ ë°ì´í„°ê°€ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    await db.budgets.clear();
                    await db.goals.clear();

                    if (data.budgets?.length > 0) {
                        // id ì œê±°í•˜ê³  ìƒˆë¡œ ì¶”ê°€
                        const budgetsToAdd = data.budgets.map(b => {
                            const { id, ...rest } = b;
                            return rest;
                        });
                        await db.budgets.bulkAdd(budgetsToAdd);
                    }
                    if (data.goals?.length > 0) {
                        // goalsëŠ” id: 1ë¡œ ê³ ì •
                        await db.goals.put({ id: 1, memo: data.goals[0].memo });
                    }

                    alert('ë³µì› ì™„ë£Œ!');
                    refreshAllData();
                    loadGoal();
                } catch (error) {
                    alert('ë³µì› ì‹¤íŒ¨: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Refresh All Data
        function refreshAllData() {
            calculateTotalBalance();
            updateMonthlyStats();
        }

        // Initialize
        function initializeApp() {
            updateCategoryOptions('expense', document.getElementById('budgetCategory'));
            document.getElementById('budgetDate').value = getTodayDateString();

            document.getElementById('budgetType').addEventListener('change', (e) => {
                updateCategoryOptions(e.target.value, document.getElementById('budgetCategory'));
            });

            document.getElementById('saveBudgetBtn').addEventListener('click', saveBudget);
            document.getElementById('clearInputBtn').addEventListener('click', clearInputFields);
            document.getElementById('saveGoalBtn').addEventListener('click', saveGoal);
            document.getElementById('editGoalBtn').addEventListener('click', editGoal);
            document.getElementById('deleteGoalBtn').addEventListener('click', deleteGoal);
            document.getElementById('cancelGoalBtn').addEventListener('click', cancelEditGoal);
            document.getElementById('globalResetBtn').addEventListener('click', globalReset);

            document.getElementById('prevPageBtn').addEventListener('click', () => showPage(currentPage - 1));
            document.getElementById('nextPageBtn').addEventListener('click', () => showPage(currentPage + 1));

            window.onclick = (e) => {
                if (e.target === document.getElementById('budgetModal')) closeModal();
            };

            refreshAllData();
            showPage(1);
        }

        window.onload = initializeApp;
        window.openBudgetModal = openBudgetModal;
        window.saveModalBudget = saveModalBudget;
        window.deleteBudgetEntry = deleteBudgetEntry;
        window.closeModal = closeModal;
        window.displayDataAsJson = displayDataAsJson;
        window.importDataFromJson = importDataFromJson;
    </script>
</body>
</html>
